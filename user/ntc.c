#include "ntc.h"
#include "adc.h"

#define ARRAY_SIZE(a) (sizeof(a)/sizeof(a[0]))

//unsigned int NTC_R;//定义热敏电阻阻值变量
//unsigned char temperature;//定义温度存储变量

#if 0
unsigned int code Ttable[]={//温度与电阻阻值对应关系表格
3274,//0度对应阻值32.74k
3111,//1度对应阻值31.11k
2957,//2度对应阻值29.57k
2812,//
2674,//
2545,
2422,
2306,
2196,
2092,
1993,
1900,
1811,
1728,
1648,
1573,
1501,
1433,
1369,
1308,
1250,
1194,
1142,
1092,
1045,
1000,//25度对应阻值10k		
957,//26度对应阻值9.57k
916,
877,
840,
805,//30
771,
739,
709,
679,
652,
625,
600,
576,
553,
531,//40
510,
490,
471,
453,
435,//45
418,
402,
387,
372,
358,//50
345,
332,
320,
308,
297,//55
286,
276,//57
266,
256,
247,//60
238, 
230,
222,
214,
207,//65
199,
193,
186,
180,
174,//70
168,
162,
157,
152,
147,//75
142,
137,
133,
128,
124,//80
120,
116,
113,
109,
106,
102,//86度对应阻值1.02k
99,//87度对应阻值0.99k
96,
93,
90,
88,
85,
82,
80,
78,
75,
73,
71,
69,
67,
65,
63,
61, 
59,
58//105度对应阻值0.58k
};	


uint16 code ntc10k_tab[] = {
2801, /* 0 */ 
2682, /* 1 */ 
2569, /* 2 */ 
2462, /* 3 */ 
2361, /* 4 */ 
2266, /* 5 */ 
2175, /* 6 */ 
2089, /* 7 */ 
2007, /* 8 */ 
1929, /* 9 */ 
1856, /* 10 */ 
1848, /* 11 */ 
1814, /* 12 */ 
1763, /* 13 */ 
1699, /* 14 */ 
1628, /* 15 */ 
1553, /* 16 */ 
1478, /* 17 */ 
1405, /* 18 */ 
1335, /* 19 */ 
1269, /* 20 */ 
1206, /* 21 */ 
1149, /* 22 */ 
1095, /* 23 */ 
1045, /* 24 */ 
1000, /* 25 */ 
957, /* 26 */    //0x91-0x9e   2022-04-01
918, /* 27 */ 
881, /* 28 */ 
847, /* 29 */ 
816, /* 30 */ 
786, /* 31 */ 
757, /* 32 */ 
731, /* 33 */ 
705, /* 34 */ 
681, /* 35 */ 
658, /* 36 */ 
635, /* 37 */ 
614, /* 38 */ 
593, /* 39 */ 
573, /* 40 */ 
554, /* 41 */ 
535, /* 42 */ 
517, /* 43 */ 
499, /* 44 */ 
482, /* 45 */ 
466, /* 46 */ 
450, /* 47 */ 
435, /* 48 */ 
420, /* 49 */ 
406, /* 50 */ 
392, /* 51 */ 
379, /* 52 */ 
366, /* 53 */ 
353, /* 54 */ 
341, /* 55 */ 
329, /* 56 */ 
317, /* 57 */ 
305, /* 58 */ 
294, /* 59 */ 
282, /* 60 */ 
277, /* 61 */ 
271, /* 62 */ 
265, /* 63 */ 
258, /* 64 */ 
250, /* 65 */ 
243, /* 66 */ 
235, /* 67 */ 
228, /* 68 */ 
220, /* 69 */ 
213, /* 70 */ 
206, /* 71 */ 
200, /* 72 */ 
193, /* 73 */ 
187, /* 74 */ 
182, /* 75 */ 
177, /* 76 */ 
172, /* 77 */ 
167, /* 78 */ 
162, /* 79 */ 
158, /* 80 */ 
154, /* 81 */ 
150, /* 82 */ 
147, /* 83 */ 
143, /* 84 */ 
140, /* 85 */ 
136, /* 86 */ 
133, /* 87 */ 
130, /* 88 */ 
126, /* 89 */ 
123, /* 90 */ 
120, /* 91 */ 
117, /* 92 */ 
113, /* 93 */ 
110, /* 94 */ 
107, /* 95 */ 
104, /* 96 */ 
101, /* 97 */ 
97, /* 98 */ 
94, /* 99 */ 
 91, /* 100 */ 
 88, /* 101 */ 
 86, /* 102 */ 
 83, /* 103 */ 
 81, /* 104 */ 
 78, /* 105 */ 

};

#endif

//2022-04-03 调整，温度有点差值，向后调整两个数2022-04-03
uint16 code ntc10k_tab[] = {
//841, /* 0 */ 
//833, /* 1 */ 
830, /* 2 */ 
823, /* 3 */ 
816, /* 4 */ 
808, /* 5 */ 
801, /* 6 */ 
792, /* 7 */ 
783, /* 8 */   // 0x315
776, /* 9 */ 
769, /* 10 */ 
762, /* 11 */ 
755, /* 12 */ 
748, /* 13 */ 
741, /* 14 */ 
734, /* 15 */ 
727, /* 16 */ 
720, /* 17 */ 
712, /* 18 */ 
704, /* 19 */ 
696, /* 20 */ 
688, /* 21 */ 
681, /* 22 */ 
674, /* 23 */ 
667, /* 24 */   //0x29d
659, /* 25 */ 
650, /* 26 */    //0x91-0x9e   2022-04-01
640, /* 27 */ 
631, /* 28 */  //0x277 
623, /* 29 */ 
615, /* 30 */ 
608, /* 31 */ 
601, /* 32 */ 
593, /* 33 */ 
586, /* 34 */   //0x24A
578, /* 35 */ 
570, /* 36 */ 
562, /* 37 */ 
555, /* 38 */ 
548, /* 39 */ 
540, /* 40 */ 
533, /* 41 */ //0x215
527, /* 42 */ 
521, /* 43 */ 
515, /* 44 */ 
510, /* 45 */ 
505, /* 46 */ 
500, /* 47 */ 
495, /* 48 */ 
490, /* 49 */ 
485, /* 50 */ 
480, /* 51 */ 
475, /* 52 */ 
470, /* 53 */ 
465, /* 54 */    //0x1d1
460, /* 55 */ 
455, /* 56 */ 
450, /* 57 */ 
445, /* 58 */ 
440, /* 59 */ 
435, /* 60 */ 
430, /* 61 */ 
425, /* 62 */ 
420, /* 63 */ 
416, /* 64 */ 
412, /* 65 */ 
408, /* 66 */ 
404, /* 67 */ 
400, /* 68 */ 
396, /* 69 */ 
392, /* 70 */ 
388, /* 71 */ 
384, /* 72 */ 
380, /* 73 */ 
376, /* 74 */ 
372, /* 75 */ 
368, /* 76 */  //0x170
365, /* 77 */ 
363, /* 78 */ 
360, /* 79 */ 
357, /* 80 */ 
354, /* 81 */ 
353, /* 82 */ 
350, /* 83 */ 
347, /* 84 */ 
344, /* 85 */ 
341, /* 86 */ 
338, /* 87 */ 
335, /* 88 */ 
332, /* 89 */ 
329, /* 90 */ 
326, /* 91 */ 
323, /* 92 */ 
320, /* 93 */ 
318, /* 94 */ 
316, /* 95 */ 
313, /* 96 */ 
311, /* 97 */ 
309, /* 98 */ 
307, /* 99 */   //0x133
305, /* 99 */
303 /* 99 */
};



static int8 NTC_bSearch(uint16 *tab, uint8 tab_size, int16 val)
{
    uint8 mid	= 0; 
    uint8 left	= 0; 
	uint8 right	= tab_size - 1;
//	char t1,t2,t3;

	if(val > tab[0]) return -1; // 温度下限
	else if(val < tab[tab_size - 1]) return -2; // 温度上限

    while(left <= right)
	{ 
        mid = (right + left) / 2;
        if(val == tab[mid])
            return mid;
        else if (val > tab[mid])
            right = mid - 1;
        else if (val < tab[mid])
            left = mid + 1;
	}

	//这里正好没有取到对应值
	if(val > tab[mid])  //向左边看看
	{	
		right = val - tab[mid] ;
		left = tab[mid-1] - val;    //左边的值肯定更大
		if(left<right)            //与左边的差值更小
			mid --;   //向左边取一个
	}
	else 
	{	
		left = tab[mid] - val;
		right = val -  tab[mid+1] ;    //右边的值肯定更小
		if(left>right)            //与右边的差值更小
			mid ++;   //向左边取一个
	}
	
	
    return mid;
}


char T_dis(unsigned int t_val){//温度处理函数采集到的阻值与二维数组的阻值进行比较，从而获得相对应的温度值。

	//return NTC_bSearch(Ttable, sizeof(Ttable)/sizeof(Ttable[0]), t_val);
	return NTC_bSearch(ntc10k_tab, sizeof(ntc10k_tab)/sizeof(ntc10k_tab[0]), t_val);
}

